---
layout: post
title: gitflow版本管理、gitlab搭建、CICD（待梳理）
category: dev-ops
tags: [dev-ops]
---

gitflow版本管理、gitlab搭建、CICD

## 一、gitflow版本管理  
### 1、背景分析
- 问题  
 使用git管理代码时，都只有一个master版本，所有开发人员使用一个git来进行开发，导致开发过程中的问题凸显出来：

  1. 合并过程中经常将别人的源码覆盖。
  2. 版本管理混乱，每个版本都没有创建tag标记。
  3. 没有将发布版本和开发版本区分开。
  4. 解决现场问题时，无法快速切换到某一版本。
  5. 提交树混乱，没有规范项目组内提交内容的格式。

- 改进  
  基于上述的问题和对别的项目组的借鉴，采用git flow的开发模式。优点有下面几方面：

  1. 基于版本开发和发布
  2. 基于功能开发，功能之间代码互不干扰
  3. 符合持续发布的风格

### 2、git flow使用规范
#### 2.1、Git Flow常用的分支
- production 分支(master)  
  也就是我们经常使用的Master分支，这个分支最近发布到生产环境的代码，最近发布的Release， 这个分支只能从其他分支合并，不能在这个分支直接修改
- develop 分支  
  这个分支是我们是我们的主开发分支，包含所有要发布到下一个Release的代码，这个主要合并与其他分支，比如Feature分支
- feature 分支  
  这个分支主要是用来开发一个新的功能，一旦开发完成，我们合并回Develop分支进入下一个Release
- release分支  
  当你需要一个发布一个新Release的时候，我们基于Develop分支创建一个Release分支，完成Release后，我们合并到Master和Develop分支
- hotfix分支  
  当我们在Production发现新的Bug时候，我们需要创建一个Hotfix, 完成Hotfix后，我们合并回Master和Develop分支，所以Hotfix的改动会进入下一个Release

#### 2.2、分支命名规范
- master分支  
  master分支不变，始终叫master，始终不会被删除。
- develop分支  
  同master分支，名字不变。始终叫develop，始终不会被删除。
- feature分支  
  - 组件：命名规范为`feature/功能名称`，开发阶段不用加版本号。
  - 产品：命名规范为`feature/产品版本`，需要加上当前产品的版本号。
  - 小功能可以直接基于develop进行修改。  
  使用完成之后，将该分支删除。
- release分支    
  命名规范为`release/产品版本号`，以产品的版本号为准，例如产品版本为v2.2，那这几就是release/v2.2。使用完成之后，将该分支删除。
- hotfix分支    
  命名规范为`hotfix/产品版本号`，以要以产品的版本为准，例如产品版本为v2.2，那这几就是release/v2.2。使用完成之后，将该分支删除。

#### 2.3、产品约束
- 为合理管理分支，所有的分支均有主程序员创建，其他程序员切换到该分支进行开发。
- master分支分支平时处于锁定，**不允许**开发人员直接提交代码。
- develop分支处于开放状态，允许小功能修改及提交。
- 开发阶段
  - 同一时间，如果有多个功能处于开发阶段，为了减小冲突。基于功能打Feature分支，例如要开发example1和example2功能，则打两个Feature分支，名称为feature/example1和feature/example2分支，不同Feature分支中代码**不能**交叉提交。
- 测试阶段
  - 当项目提交测试时，将需要这一版改造的feature合并到develop分支。
  - 如果版本要发布的功能部分完成时，在develop分支上提测。
- 发布阶段
  - 发布阶段将release分支合并到develop和master分支上。
  - **release合并到master分支时，必须增加版本号作为tag。**

#### 2.4、git commit约束
以前大家的commit message各种各样，没有统一规范 
commit时，message需要清晰的描述出修改的内容，不要出现`修改bug`/`修改`等不清楚的描述。

建议参考[Git commit message和工作流规范](https://ivweb.io/topic/58ba702bdb35a9135d42f83d)，当前产品先不做要求。

#### 2.5、pull request & Code Review
GitHub Flow

所谓 GitHub Flow，其实也叫 Forking flow，也就是 GitHub 上的那个开发方式。
- 每个开发人员都把“官方库”的代码 fork 到自己的代码仓库中。
- 然后，开发人员在自己的代码仓库中做开发，想干啥干啥。
- 因此，开发人员的代码库中，需要配两个远程仓库，一个是自己的库，一个是官方库（用户的库用于提- 交代码改动，官方库用于同步代码）。
- 然后在本地建“功能分支”，在这个分支上做代码开发。
- 这个功能分支被 push 到开发人员自己的代码仓库中。
- 然后，向“官方库”发起 pull request，并做 Code Review。
- 一旦通过，就向官方库进行合并。  

这就是 GitHub 的工作流程。

如果你有“官方库”的权限，那么就可以直接在“官方库”中建功能分支开发，然后提交 pull request。通过 Code Review 后，合并进 Master 分支，而 Master 一旦有代码被合并就可以马上 release。

这是一种非常 Geek 的玩法。这需要一个自动化的 CI/CD 工具做辅助。是的，CI/CD 应该是开发中的标配了。

### 3、 参考资料
下面是几个链接是git flow的详细说明和使用方法。    
[干货！如何正确使用Git Flow](http://www.codeceo.com/article/how-to-use-git-flow.html)    
[Git 工作流程](http://www.ruanyifeng.com/blog/2015/12/git-workflow.html)  

## 二、gitlab搭建
《Jenkins持续集成入门到精通》-Gitlab代码托管服务器安装

### 问题记录:  
```
gitlab搭建
https://blog.csdn.net/duyusean/article/details/80011540
https://www.jianshu.com/p/ade38a53b1ac
《Jenkins持续集成从入门到精通.pdf》

1.如果报错了，Gitlab 默认的日志文件存放在/var/log/gitlab/reconfigure 目录下，可以看一下具体的错误信息。
ERROR: execute[semodule -i /opt/gitlab/embedded/selinux/rhel/7/gitlab-7.2.0-ssh-keygen.pp] (gitlab::selinux line 20) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received '127'
---- Begin output of semodule -i /opt/gitlab/embedded/selinux/rhel/7/gitlab-7.2.0-ssh-keygen.pp ----
解决方案：sudo yum install libsemanage-static libsemanage-devel
然后重启：sudo gitlab-ctl reconfigure 
————————————————

2.The chef recipe still fails with SELinux inside of OpenVZ containers: 
Error executing action `run` on resource 'execute[semodule -i /opt/gitlab/embedded/selinux/rhel/7/gitlab-7.2.0-ssh-keygen.pp]' 
Expected process to exit with [0], but received '1'
---- Begin output of semodule -i /opt/gitlab/embedded/selinux/rhel/7/gitlab-7.2.0-ssh-keygen.pp ----
STDOUT: 
STDERR: semodule: SELinux policy is not managed or store cannot be accessed.
---- End output of semodule -i /opt/gitlab/embedded/selinux/rhel/7/gitlab-7.2.0-ssh-keygen.pp ----
Ran semodule -i /opt/gitlab/embedded/selinux/rhel/7/gitlab-7.2.0-ssh-keygen.pp returned 1 

I "fixed" this by commenting out all the lines in
/opt/gitlab/embedded/cookbooks/gitlab/recipes/selinux.rb
 
I fixed this with running this
gitlab-ctl start postgresql

Followed by this
gitlab-ctl reconfigure

3.访问502错误，内存修改为3G

4无法修改密码
.https://gitlab.com/gitlab-org/gitlab/-/issues/28294
https://www.jianshu.com/p/f9e725c44475

按照官网配置会有坑
官方详解邮件服务配置
1. 配置文件位置/etc/gitlab/gitlab.rb

以腾讯企业邮箱为例其它邮箱大同小异
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtp.exmail.qq.com"
gitlab_rails['smtp_port'] = 465
gitlab_rails['smtp_user_name'] = "test@qq.com"
gitlab_rails['smtp_password'] = "test123"
gitlab_rails['smtp_authentication'] = "login"
gitlab_rails['smtp_enable_starttls_auto'] = true
gitlab_rails['smtp_tls'] = true
gitlab_rails['smtp_domain'] = "exmail.qq.com"
gitlab_rails['gitlab_email_from'] = 'test@qq.com'
端口号实际测试是465，gitlab给出的是587

2.更新配置 gitlab-ctl reconfigure

（测试发现控制台调试第四步生效了，但是页面发送邮件并没有立即生效）

3.重启服务 gitlab-ctl restart

4.非必需步骤进入控制台gitlab-rails console （测试邮件服务是否正常）
Notify.test_email('test@qq.com','email title','email content desc').deliver_now 
```

## 三、基于gitlab CICD流程







